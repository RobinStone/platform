<?phpclass PROPS_COMMANDER {    public array $i_bool = [];    public array $i_float = [];    public array $i_int = [];    public array $i_json = [];    public array $i_char = [];    public array $i_string = [];    public array $i_text = [];    private array $schema;    /**     * @param array $indexer_ids     * @param bool $all_props     */    function __construct(array $indexer_ids, bool $all_props = false) {        if(empty($indexer_ids)) {            return;        }        $this->schema = get_product_schema();        SORT::change_preview_key($this->schema, 'id', 'field_name');//        say($this->schema);        $props_ids = [];        $this->i_string = SQL_ROWS(q("SELECT * FROM i_string WHERE indexer_id IN (".implode(',',$indexer_ids).")"));        if($all_props && count($this->i_string) > 0) {            $new_props_ids = array_column($this->i_string, 'props_id');            $props_ids = array_unique(array_merge($props_ids, $new_props_ids));        }        $this->i_int = SQL_ROWS(q("SELECT * FROM i_int WHERE indexer_id IN (".implode(',',$indexer_ids).")"));        if($all_props && count($this->i_int) > 0) {            $new_props_ids = array_column($this->i_int, 'props_id');            $props_ids = array_unique(array_merge($props_ids, $new_props_ids));        }        $this->i_float = SQL_ROWS(q("SELECT * FROM i_float WHERE indexer_id IN (".implode(',',$indexer_ids).")"));        if($all_props && count($this->i_float) > 0) {            $new_props_ids = array_column($this->i_float, 'props_id');            $props_ids = array_unique(array_merge($props_ids, $new_props_ids));        }        $this->i_bool = SQL_ROWS(q("SELECT * FROM i_bool WHERE indexer_id IN (".implode(',',$indexer_ids).")"));        if($all_props && count($this->i_bool) > 0) {            $new_props_ids = array_column($this->i_bool, 'props_id');            $props_ids = array_unique(array_merge($props_ids, $new_props_ids));        }        $this->i_text = SQL_ROWS(q("SELECT * FROM i_text WHERE indexer_id IN (".implode(',',$indexer_ids).")"));        if($all_props && count($this->i_text) > 0) {            $new_props_ids = array_column($this->i_text, 'props_id');            $props_ids = array_unique(array_merge($props_ids, $new_props_ids));        }        $this->i_json = SQL_ROWS(q("SELECT * FROM i_json WHERE indexer_id IN (".implode(',',$indexer_ids).")"));        if($all_props && count($this->i_json) > 0) {            $new_props_ids = array_column($this->i_json, 'props_id');            $props_ids = array_unique(array_merge($props_ids, $new_props_ids));        }        $this->i_char = SQL_ROWS(q("SELECT * FROM i_char WHERE indexer_id IN (".implode(',',$indexer_ids).")"));        if($all_props && count($this->i_char) > 0) {            $new_props_ids = array_column($this->i_char, 'props_id');            $props_ids = array_unique(array_merge($props_ids, $new_props_ids));        }        if($all_props && count($props_ids) > 0) {            $this->append_additional_schema_from_ids($props_ids);        }        $this->execute_schema($this->i_string);        $this->execute_schema($this->i_int);        $this->execute_schema($this->i_float);        $this->execute_schema($this->i_bool);        $this->execute_schema($this->i_text);        $this->execute_schema($this->i_json);        $this->execute_schema($this->i_char);    }    public function get_all_props(): array    {        $result = [];        foreach($this->i_string as $v) {            if(isset($v['alias'])) {                $result[$v['indexer_id']][$v['alias']][] = $v;            }        }        foreach($this->i_int as $v) {            if(isset($v['alias'])) {                $result[$v['indexer_id']][$v['alias']][] = $v;            }        }        foreach($this->i_float as $v) {            if(isset($v['alias'])) {                $result[$v['indexer_id']][$v['alias']][] = $v;            }        }        foreach($this->i_bool as $v) {            if(isset($v['alias'])) {                $result[$v['indexer_id']][$v['alias']][] = $v;            }        }        foreach($this->i_text as $v) {            if(isset($v['alias'])) {                $result[$v['indexer_id']][$v['alias']][] = $v;            }        }        foreach($this->i_json as $v) {            if(isset($v['alias'])) {                $result[$v['indexer_id']][$v['alias']][] = $v;            }        }        foreach($this->i_char as $v) {            if(isset($v['alias'])) {                $result[$v['indexer_id']][$v['alias']][] = $v;            }        }        return $result;    }    private function execute_schema(&$arr) {        if(empty($arr)) {            return;        }        foreach($arr as $k=>$v) {            if(isset($this->schema[$v['props_id']]['alias'])) {                $arr[$k] = [                    'schema_id' => $v['props_id'],                    'indexer_id' => $v['indexer_id'],                    'value' => $v['val'],                    'id' => $v['id'],                    'alias' => $this->schema[$v['props_id']]['alias'],                    'field_name' => $this->schema[$v['props_id']]['field_name'],                ];            } else {                say('Существует значение в БД для которой не нашлось схемы ID = '.$v['props_id']);            }        }    }    /**     * Добавляет дополнительные поля в общую схему     * @param array $ids     * @return void     */    private function append_additional_schema_from_ids(array $ids) {        $rows = SQL_ROWS_FIELD(q("SELECT * FROM `filters` WHERE `id` IN (".implode(',',$ids).") "), 'id');        foreach($rows as $v) {            if (isset($v['default']) && !empty($v['default'])) {                $unserialized = @unserialize($v['default']); // Используем @ для подавления ошибок                if ($unserialized !== false || $v['default'] === 'b:0;') {                    $v['default'] = $unserialized;                }            }            $this->schema[$v['id']] = $v;        }    }    public static function aply_values_for_additional_schema(array &$schema, array $values) {        foreach($schema as &$v) {            if(isset($v['alias']) && isset($values[$v['alias']])) {                $v['id_i'] = $values[$v['alias']][0]['id'];                $v['value'] = $values[$v['alias']][0]['value'];                if(isset($v['ITEMS']) && is_array($v['ITEMS'])) {                    self::aply_values_for_additional_schema($v['ITEMS'], $values);                }            } else {                if(is_array($v)) {                    self::aply_values_for_additional_schema($v, $values);                }            }        }    }    /**     * Позволяет получить любое свойство товара     *     * @param int $shop_id - id магазина     * @param int $prod_id - id товара     * @param string $prop_rus_name_or_table_field - имя поискового параметра     * доступны для вызова из таблицы: 'Широта', 'Долгота', 'IDcountry', 'IDcity'     * 'id', 'active', 'status', 'name', 'price', 'count', 'owner_id', 'city_id',     * 'showed', 'category', 'under-cat', 'action-list', 'created', 'changed', 'active_to'     * @return mixed     */    public static function get_prop(int $shop_id, int $prod_id, string $prop_rus_name_or_table_field): mixed    {        $schema = get_product_schema();        $coords = ['Широта', 'Долгота', 'IDcountry', 'IDcity'];        $indexer_table = ['id', 'active', 'status', 'name', 'price',            'count', 'owner_id', 'city_id', 'showed', 'category',            'under-cat', 'action-list', 'created', 'changed', 'active_to'];        if(isset($schema[$prop_rus_name_or_table_field])) {            if($indexer_id = SQL_ONE_ROW(q("SELECT id FROM indexer WHERE prod_id=".$prod_id." AND shop_id=".$shop_id." LIMIT 1"))) {                $indexer_id = (int)$indexer_id['id'];                if(isset($coords[$prop_rus_name_or_table_field])) {                    return SQL_ONE_ROW(q("SELECT `".$prop_rus_name_or_table_field."` FROM coords WHERE id=".$indexer_id));            } else {                    $prop_item = $schema[$prop_rus_name_or_table_field];                    return SQL_ONE_ROW(q("SELECT `val` FROM `i_".$prop_item['type']."` WHERE `props_id`=".$prop_item['id']." AND indexer_id=".$indexer_id))['val'];                }            }        } elseif(in_array($prop_rus_name_or_table_field, $indexer_table)) {            switch($prop_rus_name_or_table_field) {                case 'category': $prop_rus_name_or_table_field = 'shops_categorys'; break;                case 'under-cat': $prop_rus_name_or_table_field = 'shops_undercats'; break;                case 'action-list': $prop_rus_name_or_table_field = 'shops_lists'; break;            }            if($indexer_ans = SQL_ONE_ROW(q("SELECT `".$prop_rus_name_or_table_field."` FROM indexer WHERE prod_id=".$prod_id." AND shop_id=".$shop_id." LIMIT 1"))) {                return $indexer_ans[$prop_rus_name_or_table_field];            }        }        return null;    }}