let begin_changer = false;window.addEventListener('load', function() {    ymaps.ready(function() {        let suggestView = new ymaps.SuggestView('address');    });    if(localStorage.getItem('formValues') !== null) {        setTimeout(function() {            load_buff();        }, 200);    } else {        let url = new URL(location.href);        if(url.searchParams.get('com') !== 'edit') {            setTimeout(function() {                begin_changer = true;            }, 200);        }    }});// let buff_inpt = '';// $(document).on('click', '#address', function(e) {//     buff_inpt = $(this).val();//     $(this).val('');// });// $(document).on('mouseleave', '#address', function(e) {//     if ($(this).val() == '') {//         $(this).val(buff_inpt);//     }// });let timer_saver = null;function changer() {    if(timer_saver !== null) {        clearTimeout(timer_saver);    }    if(begin_changer) {        timer_saver = setTimeout(function () {            save_buff();            timer_saver = null;            // console.log('saved.');            // say('SAVED');            $('#cleator').css('display', 'flex');        }, 1000);    }}$(document).on('input', 'input, textarea, select', function(e) {    changer();});$(document).on('input', '#address', function(e) {    $('.lime-back').removeClass('lime-back');});$(document).on('change, blur', '#address', function(e) {    update_place();});$(document).on('click', 'tr[data-list="true"]', function(e) {    let inpt = $(this).find('td:nth-child(2) input');    let lst = {        'Добавить номер в список': function() {            info_inputString(undefined, function() {                let buff = bufferText;                info_inputString(undefined, function() {                    SENDER('add_phone', {number: buff, descr: bufferText}, function(mess) {                        mess_executer(mess, function(mess) {                            $(inpt).val(buff);                            phones[buff] = bufferText;                        });                    });                }, 'Введите коментарий к номеру<br>:'+buff, '', 'Ввод');            }, 'Введите номер телефона, который будет помещён в список ваших контактов:', '', 'Ввод');        },    };    for(let i in phones) {        lst[phones[i]['number']+" - "+phones[i]['descr']] = function() {            $(inpt).val(phones[i]['number']);            changer();        };    }    info_variants(transform_pos('center'), lst, 'Укажите телефон, который будет привязан к этому лоту:');});function update_place() {    setTimeout(function() {        let addr = $('#address').val();        if(addr.length > 2) {            let geocoder = ymaps.geocode(addr);            geocoder.then(                function (res) {                    let firstGeoObject = res.geoObjects.get(0);                    // Проверка на наличие геообъекта                    if (!firstGeoObject) {                        say('Ошибка поиска, пожалуйста укажите более конкретный адрес...', 2)                        return;                    }                    let coords = firstGeoObject.geometry.getCoordinates();                    let ans = {};                    let addressComponents = firstGeoObject.properties.get('metaDataProperty.GeocoderMetaData.Address.Components');                    for(let i in addressComponents) {                        ans[addressComponents[i].kind] = addressComponents[i].name;                    }                    if(typeof ans['locality'] === 'undefined') {                        ans['locality'] = addr;                    }                    set_value_field('Широта', coords[0]);                    set_value_field('Долгота', coords[1]);                    place_GEO_to_id_GEO(ans);                    changer();                    // console.dir(coords);                    // console.dir(ans);                    SENDER('save_new_address', {address: addr}, function(mess) {                        mess_executer(mess, function(mess) {                            $('#address').closest('td').addClass('lime-back');                        });                    });                },                function (err) {                    say('error');                    console.log(err);                }            );        }    }, 300);}function add_properties() {    let lst = {        'Число (1, 2, 3... 1.2, 2.3...)': function() {            add_prop('float');        },        'Строка (строка до 255 символов)': function() {            add_prop('string');        },        // 'Текст (многострочный текст)': function() {        //     add_prop('text');        // },        'Ссылка (на видео, на сторонний сайт (ресурс))': function() {            add_prop('link');        },    };    if($('.insert-files').length === 0) {        lst['Изображение (фото)'] = function() {            add_prop('image');        };    }    info_variants(undefined, lst);}// Добавление динамических полейfunction add_prop(type, visible=1, blocked=0, key_val = []) {    let bl = ' opacity: 0.3; pointer-events: none; ';    let vis = ' display: none; ';    let btn_del = '';    if(visible) { vis = ''; }    if(!blocked) {        bl = '';        btn_del = '<td width="40" style="text-align: right; vertical-align: baseline"><button onclick="del_item_set(this)" class="remoover-btn action-btn">&#10005;</button></td>';    }    let block = '';    switch(type) {        case 'float':        case 'number':            block = $('<tr style="'+vis+' '+bl+'" class="created-row" data-type="number"><td><input list="list-number" placeholder="название поля" type="text"></td><td><input placeholder="число" type="number"></td>'+btn_del+'</tr>');            if(key_val !== []) {                $(block).find('td:first-child input').val(key_val[0]);                $(block).find('td:nth-child(2) input').val(key_val[1]);            }            break;        case 'string':            block = $('<tr style="'+vis+' '+bl+'" class="created-row" data-type="string"><td><input list="list-string" placeholder="название поля" type="text"></td><td><input placeholder="строка до 255 симв." type="text"></td>'+btn_del+'</tr>');            if(key_val !== []) {                $(block).find('td:first-child input').val(key_val[0]);                $(block).find('td:nth-child(2) input').val(key_val[1]);            }            break;        case 'list':            block = $('<tr data-list="true" style="'+vis+' '+bl+'" class="created-row" data-type="list"><td><input list="list-string" placeholder="название поля" type="text"></td><td><input placeholder="укажите вариант из списка" type="text"></td>'+btn_del+'</tr>');            break;        case 'text':            block = $('<tr style="'+vis+' '+bl+'" class="created-row" data-type="text"><td><input list="list-text" placeholder="название поля" type="text"></td><td><textarea placeholder="текст"></textarea></td>'+btn_del+'</tr>');            if(key_val !== []) {                $(block).find('td:first-child input').val(key_val[0]);                $(block).find('td:nth-child(2) textarea').val(key_val[1]);            }            break;        case 'link':            block = $('<tr style="'+vis+' '+bl+'" class="created-row" data-type="link"><td><input list="list-link" placeholder="название поля" type="text"></td><td><input placeholder="https://" type="text"></td>'+btn_del+'</tr>');            if(key_val !== []) {                $(block).find('td:first-child input').val(key_val[0]);                $(block).find('td:nth-child(2) input').val(key_val[1]);            }            break;        case 'image':            block = $('<tr style="'+vis+' '+bl+'" data-type="image"><td>Изображение<br>(фото)</td><td class="insert-files"><label class="action-btn"><input id="file-input" type="file" accept=".jpg, .jpeg, .webp, .png, .gif"></label><div class="list-prev-img flex gap-5"></div></td>'+btn_del+'</tr>');            break;        case 'doc':            block = $('<tr style="'+vis+' '+bl+'" class="created-row" data-type="doc"><td>Документ<br>(WORD, Exel, PDF)</td><td class="insert-files"><label class="action-btn doc"><input id="file-input-doc" type="file" accept=".docx, .pdf, .exel"></label</td>'+btn_del+'</tr>');            break;        default:            say('Не найден нужный тип поля!..', 2);            break;    }    if(block !== '') {        $('.product-creator table:first-child').append(block);    }    check_count_type();    return block;}function create_user_line(type, param, argum) {    add_prop(type, 1, 0, [param, argum]);}function get_last_fields_form() {    SENDER_APP('get_last_fields_form', {}, function(mess) {        console.dir(mess);    });}function del_item_set(obj) {    $(obj).closest('tr').remove();}upload_files = [];$(document).on('change', '#file-input', function(e) {    let imgs = this;    let count_imgs = $('.list-prev-img button').length;    for(let fil of imgs.files) {        if(count_imgs === 5) {            say('Разрешено добавлять только 5 изображений.', 2);            return false        }        let reader = new FileReader();        reader.onload = function(event) {            const image = new Image();            image.src = event.target.result;            let fileSizeInBytes = imgs.files[0].size;            let fileSizeInMegabytes = fileSizeInBytes / (1024 * 1024);            console.log('Размер файла: ' + fileSizeInMegabytes + ' МБ');            if(fileSizeInMegabytes > 5) {                say('Файл занимает '+fileSizeInMegabytes+' Мб. Это много. Поищите другую фотографию, пожалуйста...', 2);            } else {                let btn = $('<button onclick="del_img(this)" data-name="'+imgs.files[0].name+'" class="img-btn action-btn" title="Удалить изображение"></button>');                $(image).attr('data-src', imgs.files[0].name);                $(btn).append(image);                $('.list-prev-img').append(btn);                upload_files.push(event.target.result);                console.log('UPLOAD_FILES COUNT='+upload_files.length);                changer();            }        }        reader.readAsDataURL(fil);        ++count_imgs;    }});function del_img(obj) {    info_qest(undefined, function() {        if($(obj).hasAttr('data-old-props-id')) {            let url = new URL(location.href);            SENDER_APP('del_param_from_order', {                shop_id: url.searchParams.get('s'),                param_id: $(obj).attr('data-old-props-id'),            }, function(mess) {                mess_executer(mess, function() {                    say('ok');                });            });        }        let name = $(obj).attr('data-src');        upload_files.splice(upload_files.indexOf(name), 1);        $(obj).remove();        changer();    }, function() {    }, 'Удалить это изображение ?', 'Да - удалить', 'Нет');}function set_loader_shore(obj) {    let div = $('<div class="shore-created" style="position: absolute;left:0;top:0;width:100%;height:100%;display:flex;justify-content:center;align-items: center;background-color: rgba(0,0,0,0.73);"><img width="80" height="80" src="/IMG/SYS/loader.gif"></div>');    $(obj).append(div);}function validate_form() {    let lst = [];    let name = '';    let errors = 0;    if($('.list-prev-img img').length === 0) {        ++errors;    }    $('.created-row').each(function(e, t) {        name = $(t).find('td:first-child input').val();        if(name === '' || lst.includes(name)) {            $(t).find('td:first-child').addClass('error-field');            ++errors;        } else {            lst.push(name);            $(t).find('td:first-child').removeClass('error-field');        }    });    if(errors > 0) { return false; } else { return true; }}function save_product(create_product = true) {    if(validate_form()) {        set_loader_shore($('.product-creator'));        if (upload_files.length > 0) {            let counts = upload_files.length;            let files = [];            console.dir(upload_files);            $('.list-prev-img img').each(function (e, t) {                if (!$(t).parent().hasAttr('data-old-props-id')) {                    upload_shop_img($(t), $(t).parent().attr('data-name'), function (res) {                        --counts;                        // say('counts='+counts);                        files.push(res.sys_name);                        if (counts === 0) {                            calc_and_send_new_product(files, create_product);                        }                    }, function(res) {                        $('.shore-created').remove();                        say(res.text+"<br>"+res.user_name, 2);                    });                }            });        } else {            calc_and_send_new_product([], create_product);        }    } else {        say('Объявление должно содержать хотя бы<br>одно изображение и все названия полей<br>должны быть заполнены и не содержать повторений...', 2);    }}function save_edited_product() {    save_product(1);    console.log('edited super-puper');}function calc_and_send_new_product(arr_imgs_sys_names=[], create_product=true) {    let url = new URL(location.href);    let pr_id = -1;    if(typeof url.searchParams.get('ord') !== 'undefined') {        pr_id = parseInt(url.searchParams.get('ord'));    }    let send = true;    let td = null;    let lst = {        product_id: pr_id,        name: $('.table-focus .product-creator tr[data-field="sys-name"] input').val(),        cat_id: buffer_cat_id,        under_cat_id: buffer_under_cat_id,        action_list_id: buffer_action_list_id,        count: parseInt($('.table-focus .product-creator tr[data-field="sys-count"] input').val()),        files: arr_imgs_sys_names,    };    let i = 0;    let props = {};    $('.product-creator tr[data-type]').each(function (e, t) {        let id = $(t).attr('data-id');        if (typeof id === 'undefined') {            id = -1;        }        let field_name = '';        switch ($(t).attr('data-type')) {            case 'link':            case 'string':            case 'list':            case 'number':                if($(t).find('td:nth-child(1)').find('input').length > 0) {                    field_name = $(t).find('td:nth-child(1) input').val();                } else {                    field_name = $(t).find('td:nth-child(1)').text();                }                props[i] = {                    id: id,                    type: $(t).attr('data-type'),                    field: field_name,                    value: $(t).find('td:nth-child(2) input').val(),                }                if(typeof props[i].field !== 'undefined' && props[i].field === '') { send = false; }                break;            case 'text':                if($(t).find('td:nth-child(1)').find('input').length > 0) {                    field_name = $(t).find('td:nth-child(1) input').val();                } else {                    field_name = $(t).find('td:nth-child(1)').text();                }                props[i] = {                    id: id,                    type: $(t).attr('data-type'),                    field: field_name,                    // value: $(t).find('td:nth-child(2) textarea').val(),                    value: tinymce.get('field').getContent(),                }                if(typeof props[i].field !== 'undefined' && props[i].field === '') { send = false; }                break;        }        if($(t).hasClass('created-row')) {            if($(t).find('button.remoover-btn').length === 0) {                props[i]['block'] = 1;            } else {                props[i]['block'] = 0;            }            if($(t).is(':visible')) {                props[i]['visible'] = 1;            } else {                props[i]['visible'] = 0;            }        }        ++i;    });    console.log('CALCULATED fields complite > ');    console.dir(lst);    // return false;    if(send === true && create_product === true) {        lst['props'] = props;        buffer_app = 'SHOPS';        SENDER_APP('create_product', lst, function(mess) {            mess = JSON.parse(mess);            console.dir(mess);            if(mess.status !== 'ok') {                error_executing(mess);            } else {                $('.table-focus').find('.close-window-btn').click();                clear_buffer_creator();                if(typeof buffer_method_start !== 'undefined') {                    setTimeout(buffer_method_start, 5);                }            }        })    } else {        say('not send', 3);    }}buffer_cat_id = -1;buffer_under_cat_id = -1;buffer_action_list_id = -1;function change_main_cat(obj) {    let id = parseInt($(obj).find('option[value="'+$(obj).val()+'"]').attr('data-id'));    buffer_cat_id = id;    buffer_under_cat_id = -1;    $('#under-cat').empty();    $('#action-list').empty();    SENDER_APP('get_undercats_from_cat_id', {id: id}, function(mess) {        mess = JSON.parse(mess);        if(Object.keys(mess.params).length > 0) {            $('tr[data-field="sys-under-cat"]').removeClass('disabled');        } else {            $('tr[data-field="sys-under-cat"]').addClass('disabled');            $('tr[data-field="sys-action-list"]').addClass('disabled');        }        $('#under-cat').append('<option data-id="-1" value="-">-</option>');        for(let i in mess.params) {            $('#under-cat').append('<option data-id="'+mess.params[i].id+'" value="'+mess.params[i].under_cat+'">'+mess.params[i].under_cat+'</option>');        }        changer();    });}function change_under_cat(obj) {    let id = parseInt($(obj).find('option[value="'+$(obj).val()+'"]').attr('data-id'));    buffer_under_cat_id = id;    buffer_action_list_id = -1;    $('#action-list').empty();    SENDER_APP('get_action_list_from_undercat_id', {id_cat: buffer_cat_id, id_undercat: id}, function(mess) {        mess = JSON.parse(mess);        if(Object.keys(mess.params).length > 0) {            $('tr[data-field="sys-action-list"]').removeClass('disabled');        } else {            $('tr[data-field="sys-action-list"]').addClass('disabled');        }        console.dir(mess);        $('#action-list').append('<option data-id="-1" value="-">-</option>');        for(let i in mess.params) {            $('#action-list').append('<option data-id="'+mess.params[i].id+'" value="'+mess.params[i].lists+'">'+mess.params[i].lists+'</option>');        }        changer();    });}function change_action_list(obj) {    buffer_action_list_id = parseInt($(obj).find('option[value="' + $(obj).val() + '"]').attr('data-id'));    changer();}function update_cataloger_name_to_id() {    let maincat = $('tr[data-field="sys-caterory"] td:nth-child(2) select option:selected').attr('data-id');    let undercat = $('tr[data-field="sys-under-cat"] td:nth-child(2) select option:selected').attr('data-id');    let actionlist = $('tr[data-field="sys-action-list"] td:nth-child(2) select option:selected').attr('data-id');    console.log('+++++++++++++++++++++++++++');    buffer_cat_id = maincat;    buffer_under_cat_id = undercat;    buffer_action_list_id = actionlist;}function show_list() {    let lst = {}    console.dir(list_places);    for(let i in list_places) {        if(list_places[i].length >= 2) {            lst[list_places[i]] = function() {                $('#address').val(list_places[i]);                update_place();            };        }    }    lst['Ввести новый адрес сделки'] = function() {        $('#address').val('');        $('#address').focus();        $('.lime-back').removeClass('lime-back');    }    info_variants(transform_pos('center'), lst);}function set_value_field(field_name, value) {    let field = $('tr td:contains("'+field_name+'")').closest('tr');    if(field.length === 0) {        $('tr td input').each(function(e,t) {            if($(t).val() === field_name) {                field = $(t).closest('tr');            }        });    }    if(field.length > 0) {        $(field).find('td:nth-child(2) *').val(value);    }}function place_GEO_to_id_GEO(GEO_list) {    console.dir(GEO_list);    SENDER('place_GEO_to_id_GEO', {        country: GEO_list['country'],      // country, locality, province        locality: GEO_list['locality'],    }, function(mess) {        mess_executer(mess, function(mess) {            set_value_field('IDcity', mess.params.city_id);            set_value_field('IDcountry', mess.params.country_id);        });    });}function set_count_type(stat = true) {    if(stat) {        $('tr[data-field="sys-count"] input').val(1);        $('tr[data-field="sys-count"] input').focus();    } else {        $('tr[data-field="sys-count"] input').val(-1);    }    check_count_type();    $('tr[data-field="sys-count"]').attr('edited-old', 'true');}function check_count_type() {    let obj = $('tr[data-field="sys-count"]');    $('.sel-ch').removeClass('sel-ch');    let count = parseInt($('tr[data-field="sys-count"] input').val());    if(count <= -1) {        $('.switcher .checked:nth-child(2)').addClass('sel-ch');        $('.switcher + input').css('color', '#00000000');    } else {        $('.switcher .checked:nth-child(1)').addClass('sel-ch');        $('.switcher + input').css('color', '#000000');    }    changer();}/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////let buff_form = '';function clear_buffer_creator() {    localStorage.removeItem('formValues');}function save_buff() {    // Сохранение значений формы    const divElement = document.getElementById('product-creator');    const formValues = getFormValues(divElement);    localStorage.setItem('formValues', JSON.stringify(formValues));}function load_buff() {    // Восстановление значения    const divElement = document.getElementById('product-creator');    const savedFormValues = JSON.parse(localStorage.getItem('formValues'));    console.dir(savedFormValues);    setFormValues(divElement, savedFormValues);    setTimeout(function() {        update_cataloger_name_to_id();        let imgs = document.querySelectorAll('.list-prev-img .img-btn img');        if(imgs.length > 0) {            for(let img of imgs) {                upload_files.push(img.getAttribute('src'));            }        }        setTimeout(function() {            begin_changer = true;            $('#cleator').css('display', 'flex');        }, 300);    }, 200);}function clear_all_forms() {    clear_buffer_creator();    location.reload();}// Функция для получения всех значений формы внутри divfunction getFormValues(rootElement) {    let formValues = [];    let name = '';    let val = '';    let obj = '';    let container = 'input';    let type = 'sys';    const trs = rootElement.querySelectorAll('tr');    trs.forEach(tr => {        name = $(tr).find('td:first-child').text();        type = 'sys';        container = 'input';        if(name === '') {            name = $(tr).find('td:first-child input').val();            type = 'user';        }        if(tr.querySelector('td:nth-child(2) input') !== null) {            val = tr.querySelector('td:nth-child(2) input').value;        } else if(tr.querySelector('td:last-child select') !== null) {            val = tr.querySelector('td:last-child select').value;            container = 'select';        } else {            val = '';        }        obj = tr.outerHTML;        if(name === 'Описание') {            val = tinymce.get('field').getContent();            container = 'tiny';            obj = '';        }        if(name === 'Изображение(фото)') {            type = 'NOT';        }        formValues.push({            name: name,            value: val,            obj: obj,            type: type,            container: container,        });    });    console.dir(formValues);    return formValues;}// Функция для установки всех значений формыfunction setFormValues(rootElement, formValues) {    let obj = {};    let ins = null;    $(rootElement).find('tr').each(function(e,t) {        obj = formValues[e];        ins = $(obj.obj);        if(obj.type !== 'NOT') {            if(obj.type === 'sys') {                if(obj.container === 'input') {                    $(ins).find('input').val(obj.value);                } else if(obj.container === 'select') {                    $(ins).find('select').val(obj.value);                } else if(obj.container === 'tiny') {                    tinymce.get('field').setContent(obj.value);                } else {                    say('error - not container');                }            } else if(obj.type === 'user') {                $(ins).find('td:first-child input').val(obj.name);                $(ins).find('td:nth-child(2) input').val(obj.value);            }        }        if(obj.obj !== '') {            $(t).after(ins);            $(t).remove();        }        formValues[e]['executed'] = true;    });    for(let i of formValues) {        if(typeof i['executed'] === 'undefined') {            create_user_line('string', i.name, i.value);        }    }}