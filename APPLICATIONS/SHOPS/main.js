// метод "after_loader" - запускается когда приложение стартуетafter_loader = function(obj) {    $(obj).css('width', '640px');}lst_mains = {};lst_unders = {};drag_shop = null;let move_ation_list = false;///////////////////////////////////////////////////////////////////////////// контроль активных листов$(document).on('dragstart', 'div[data-id-action-list]', function(e) {    move_ation_list = true;    e.stopPropagation();    $(this).addClass('drag-begin');    let obj = this;    let under = $(obj).closest('details[data-id-undercat]');    let main = $(under).closest('details[data-id-main-cat]');    under = $(under).attr('data-id-undercat');    main = $(main).attr('data-id-main-cat');    $('details[data-id-main-cat]').each(function(e,t) {        if($(t).attr('data-id-main-cat') !== main) {            $(t).addClass('disabled');        }    });    $('details[data-id-main-cat="'+main+'"]').find('details[data-id-undercat]').each(function(e,t) {        if($(t).attr('data-id-undercat') !== under) {            $(t).addClass('disabled');        }    });});$(document).on('dragover', 'div[data-id-action-list]', function(e) {    $(this).css('padding-top', '40px');    e.preventDefault();});$(document).on('dragleave', 'div[data-id-action-list]', function(e) {    $(this).css('padding-top', '');    e.preventDefault();});$(document).on('drop', 'div[data-id-action-list]', function(e) {    let obj = this;    console.log(obj);    $(obj).css('padding-top', '');    $('.drag-begin').insertBefore(obj);    save_action_lists_order($(obj).closest('details[data-id-undercat]').attr('data-id-undercat'));    setTimeout(function() {        $('details').removeClass('disabled');    }, 100);});///////////////////////////////////////////////////////////////////// Контроль Главных категорий$(document).on('dragstart', 'details[data-id-main-cat]', function(e) {    $(this).addClass('drag-begin');});$(document).on('dragover', 'details[data-id-main-cat]', function(e) {    $(this).css('padding-top', '40px');    e.preventDefault();});$(document).on('dragleave', 'details[data-id-main-cat]', function(e) {    $(this).css('padding-top', '');});$(document).on('drop', 'details[data-id-main-cat]', function(e) {    if($('.drag-begin').hasAttr('data-id-main-cat')) {        let obj = this;        console.log(obj);        $(this).css('padding-top', '');        $('.drag-begin').insertBefore(obj);        save_main_cats_order();    }});$(document).on('dragend', 'details[data-id-main-cat], div[data-id-action-list]', function(e) {    $('.drag-begin').removeClass('drag-begin');    setTimeout(function() {        $('details[data-id-main-cat]').removeClass('disabled');        move_ation_list = false;    }, 300);});////////////////////////////////////////////////////////////////////////////////////////// Перемещение подкатегории$(document).on('dragstart', 'details[data-id-undercat]', function(e) {    if(!move_ation_list) {        let obj = this;        set_enabled_cats(obj, false);        $(this).addClass('drag-begin');    }    e.stopPropagation();});$(document).on('dragover', 'details[data-id-undercat]', function(e) {    $(this).css('padding-top', '40px');    e.preventDefault();});$(document).on('dragleave', 'details[data-id-undercat]', function(e) {    $(this).css('padding-top', '');});$(document).on('drop', 'details[data-id-undercat]', function(e) {    if($('.drag-begin').hasAttr('data-id-undercat')) {        let obj = this;        console.log(obj);        let main_cat_id = $(obj).closest('details[data-id-main-cat]').attr('data-id-main-cat');        $(this).css('padding-top', '');        $('.drag-begin').insertBefore(obj);        save_under_cats_order(main_cat_id);    }});///////////////////////////////////////////////////////////////////////////////////////$(document).on('contextmenu', '.line-card', function(e) {    let obj = this;    e.preventDefault();    e.stopPropagation();    let lst = {        'Активировать на час': function() {            SENDER_APP('add_level_for_product', {shop_id: $(obj).attr('data-shop'), product_id: $(obj).attr('data-product-id')}, function(mess) {                mess = JSON.parse(mess);                if(mess.status !== 'ok') {                    error_executing(mess);                } else {                    say('Продлено на час от текущего времени');                }            });        },    };    info_variants(undefined, lst);    say('ok');});$(document).on('click', '.products-container', function(e) {    let obj = $(this).find('div.objects-list');    let llist = $(obj).attr('data-list-id');    if($(obj).children().length === 0) {        $(obj).append('<img width="40" height="40" src="/IMG/SYS/loader.gif">');        SENDER_APP('get_products_list', {lst: llist, render_type: 'line-card'}, function(mess) {            mess = JSON.parse(mess);            if(mess.status !== 'ok') {                error_executing(mess);            } else {                $(obj).html(mess.params);            }        });    }});$(document).on('dblclick', '.shops-list li', function(e) {});$(document).on('click', '#cat details', function(e) {    setTimeout(function() {        save_details_status();    }, 100);});$(document).on('dragstart', '.shops-list li', function(e) {    $(this).css('opacity', '0.1');    drag_shop = this;});$(document).on('dragover', '.center-wrapper-scroller', function(e) {    if(drag_shop !== null) {        $('.center-wrapper-scroller').addClass('dropper');    }    e.preventDefault();});$(document).on('dragleave', '.center-wrapper-scroller', function(e) {    if(drag_shop !== null) {        $('.center-wrapper-scroller').removeClass('dropper');    }    e.preventDefault();});$(document).on('drop', '.center-wrapper-scroller', function(e) {    let id_shop = $(drag_shop).attr('data-id-shop');    $(drag_shop).remove();    $('.center-wrapper-scroller').removeClass('dropper');    drag_shop = null;    activate_work_shop(id_shop);});$(document).on('dragend', '.shops-list li', function(e) {    $(this).css('opacity', '');    $('.center-wrapper-scroller').removeClass('dropper');    drag_shop = null;});function new_shop() {    let f = new forms('shop_creator');    f.title = 'Создание нового магазина';    f.render();}function show_owner_of_shop(user_id) {    let win = create_window(undefined, 'Обзор профиля:');    open_card(win, 'users', user_id, {}, function() {        $(win).closest('.window').find('h4 button:nth-child(2)').remove();        $(win).closest('.window').find('h4').prepend('<div class="logo-table"><img src="/IMG/SYS/infocard.svg"></div>');    });}function del_shop(btn_obj_card, id_shop) {    SENDER_APP('del_shop_access', {id_shop: id_shop}, function(mess) {    });    info_qest(undefined, function(e) {        SENDER_APP('delete_shop', {id_shop: id_shop}, function(mess) {            mess = JSON.parse(mess);            if(mess.status === 'ok') {                $(btn_obj_card).closest('li').remove();            } else {                error_executing(mess);            }        });    }, function() {    }, '<span class="yellow-text">Вам в Телеграм отправлен запрос на подтверждение удаления.<br>Прежде чем нажать на кнопку продолжить - подвердите удаление в телеграме.<br>Или нажмите "КЛЮЧ"</span><br>Магазин со всеми товарами будет безвозвратно удалён.<br>Продолжить?', 'Да. Удалить магазин', 'ОТМЕНА');}function edit_shop_card(id_shop) {    let win = create_window(undefined, 'Редактор Магазина:');    open_card(win, 'shops', id_shop, {}, function() {        $(win).closest('.window').find('h4 button:nth-child(2)').remove();        $(win).closest('.window').find('h4').prepend('<div class="logo-table"><img src="/IMG/SYS/infocard.svg"></div>');    });}function activate_work_shop(id) {    $('div[data-name-app="SHOPS"]').closest('.app-wrapper').css('display', 'none');    let url = new URL(location.href);    url.searchParams.set('get_local_shop', id);    set_local_url(url.protocol+'//'+url.hostname+'/admin?'+url.searchParams);    let cont = $('.center-wrapper-scroller');    SENDER_APP('get_local_shop', {id: id}, function(mess) {        mess = JSON.parse(mess);        if(mess.status !== 'ok') {            error_executing(mess);        } else {            $(cont).html(mess.params);        }    });}function create_product() {    let f = new forms('product_creator');  // создаёт форму, которую берёт из TEMPLATES/FORMS    f.title = 'Создание нового товара';    f.call_back = function(form) {        $(form).find('h4 b').after('<button onclick="get_last_fields_form()" class="action-btn" style="margin-left: 15px; font-size: 12px; padding: 1px 6px">На основе предыдущего</button>');    };    f.render();}function del_last() {    SENDER_APP('del_last', {}, function(mess) {        if(mess === 'ok') {            say('ok');        } else {            console.log(mess);        }    });}function props_editor() {}function upload_cataloger(obj, auto_load=false) {    if($(obj).prop('open') === false || auto_load === true) {        $('#cat').html('<img width="50" height="50" src="/DOWNLOAD/20230609-201051_id-2-217564.gif">');        SENDER_APP('get_categorys_list', {}, function(mess) {            mess = JSON.parse(mess);            if(mess.status === 'ok') {                $('#cat').html(mess.params);                load_details_status();                load_scroll();            } else {                say('Ошибка доступа...', 3);            }        })    }}function save_scroll() {    let pos = $('#cat').scrollTop();    localStorage.setItem('cat-scroll', pos);}function load_scroll() {    setTimeout(function() {        let scroll_y = localStorage.getItem('cat-scroll');        if(scroll_y !== undefined) {            $('#cat').scrollTop(scroll_y);        }    }, 200);}function add_new_cat() {    info_inputString(undefined, function(mess) {        save_scroll();        SENDER_APP('create_new_item_cataloger', {item: 'main_cat', name: bufferText}, function(mess) {            mess_executer(mess, function() {                $('#cat').empty();                upload_cataloger($('.cataloger'), true);            })        });    }, 'Создание новой категории:', 'Новая главная категория', 'Создать');}function create_new_under_cat(obj) {    info_inputString(undefined, function(mess) {        save_scroll();        SENDER_APP('create_new_item_cataloger', {item: 'under_cat', name: bufferText, id_main_cat: $(obj).closest('details').attr('data-id-main-cat')}, function(mess) {            mess_executer(mess, function() {                $('#cat').empty();                upload_cataloger($('.cataloger'), true);            })        });    }, 'Создание новой под-категории:', 'Новая под-категория', 'Создать');}function create_new_action_list(obj) {    info_inputString(undefined, function(mess) {        // say($(obj).closest('details[data-id-main-cat]').attr('data-id-main-cat'));        // say($(obj).closest('details').attr('data-id-undercat'));        // return false;        save_scroll();        SENDER_APP('create_new_item_cataloger', {            item: 'action_list',            name: bufferText,            id_main_cat: $(obj).closest('details[data-id-main-cat]').attr('data-id-main-cat'),            id_undercat: $(obj).closest('details').attr('data-id-undercat')        }, function(mess) {            mess_executer(mess, function() {                $('#cat').empty();                upload_cataloger($('.cataloger'), true);            })        });    }, 'Создание нового элемента списка:', 'Новый список', 'Создать');}function del_action_list(obj, id_main_cat, id_undercat, id_action_list) {    let name = $(obj).closest('div.llist').find('span').text();    info_qest(undefined, function() {        SENDER_APP('del_action_list', {id_main_cat: id_main_cat, id_undercat: id_undercat, id_action_list: id_action_list}, function(mess) {            mess_executer(mess, function() {                $(obj).closest('div.llist').remove();            });        });    }, function() {    }, 'Подтвердите удаление элемента списка <b>"'+name+'"</b> ?', 'Да - удалить', 'Нет - отменить');}function del_under_cat(obj, id_main_cat, id_undercat) {    let name = $(obj).closest('details[data-id-undercat]').find('summary > div.action-btn').text();    info_qest(undefined, function() {        SENDER_APP('del_under_cat', {id_main_cat: id_main_cat, id_undercat: id_undercat}, function(mess) {            mess_executer(mess, function() {                $(obj).closest('details[data-id-undercat]').remove();            });        });    }, function() {    }, 'Подтвердите полное удаление под-категории <b>"'+name+'"</b> ?', 'Да - удалить', 'Нет - отменить удаление');}function edit_category_item_name(old_name, id_item, type_item='main_cat|under_cat|action_list') {    info_inputString(undefined, function() {        SENDER_APP('edit_category_item_name', {new_name: bufferText, type_item: type_item, id_item: id_item}, function(mess) {            mess_executer(mess, function() {                $('#cat').empty();                upload_cataloger($('.cataloger'), true);            });        });    }, 'Изменение:', old_name, 'Изменить');}function save_details_status() {    lst_mains = {};    lst_unders = {};    $('details[data-id-main-cat]').each(function(e,t) {        lst_mains[$(t).attr('data-id-main-cat')] = $(t).prop('open');    });    $('details[data-id-undercat]').each(function(e,t) {        lst_unders[$(t).attr('data-id-undercat')] = $(t).prop('open');    });}function load_details_status() {    setTimeout(function() {        for(let i in lst_mains) {            if(lst_mains[i] === true) {                $('details[data-id-main-cat="'+i+'"]').prop('open', true);            }        }        for(let i in lst_unders) {            if(lst_unders[i] === true) {                $('details[data-id-undercat="'+i+'"]').prop('open', true);            }        }    }, 10);}function del_main_cat(obj, id_main_cat) {    let name = $(obj).closest('details[data-id-main-cat]').find('summary > div.action-btn').text();    info_qest(undefined, function() {        SENDER_APP('del_main_cat', {id_main_cat: id_main_cat}, function(mess) {            mess_executer(mess, function() {                $(obj).closest('details[data-id-main-cat]').remove();            });        });    }, function() {    }, 'Подтвердите полное удаление одной из основных категории <b>"'+name+'"</b> ?', 'Да - удалить', 'Нет - отменить удаление');}function save_main_cats_order() {    let order = {};    $('details[data-id-main-cat]').each(function(e,t) {        order[$(t).index()] = $(t).attr('data-id-main-cat');    });    buffer_app = 'SHOPS';    SENDER_APP('set_main_cat_order', {order: order}, function(mess) {        mess_executer(mess, function() {            console.log('order changed...');        })    });}function save_under_cats_order(main_cat_id) {    let order = {};    $('details[data-id-main-cat="'+main_cat_id+'"] details[data-id-undercat]').each(function(e,t) {        order[$(t).index()] = $(t).attr('data-id-undercat');    });    console.dir(order);    buffer_app = 'SHOPS';    SENDER_APP('set_under_cat_order', {main_cat_id: main_cat_id, order: order}, function(mess) {        mess_executer(mess, function() {            $('details[data-id-main-cat]').removeClass('disabled');            console.log('order under-cats saved...');        })    });}function save_action_lists_order(under_cat_id) {    let order = {};    $('details[data-id-undercat="'+under_cat_id+'"]').find('div[data-id-action-list]').each(function(e,t) {        order[$(t).index()] = $(t).attr('data-id-action-list');    });    console.dir(order);    buffer_app = 'SHOPS';    SENDER_APP('set_action_list_order', {under_cat_id: under_cat_id, order: order}, function(mess) {        mess_executer(mess, function() {            $('details').removeClass('disabled');            console.log('order action-lists saved...');        })    });}function set_enabled_cats(obj, status=true) {    console.log(obj);    console.log('--------------');    let par = $(obj).closest('details[data-id-main-cat]').attr('data-id-main-cat');    console.log(par);    $('details[data-id-main-cat]').each(function(e,t) {        if($(t).attr('data-id-main-cat') !== par) {            $(t).addClass('disabled');        }    });}function update_cataloger_buffer() {    buffer_app = 'SHOPS';    SENDER_APP('reset_cataloger_buffer', {}, function(mess) {        mess_executer(mess, function() {            say('Буфер очищен.');        })    });}function find_shop(obj) {    let txt = $(obj).val();    buffer_app = 'SHOPS';    SENDER_APP('find_shop', {txt: txt}, function (mess) {        mess_executer(mess, function (mess) {            console.dir(mess);            $('#all-shops').html(mess.params.res);        })    });}function show_shop(obj) {    buffer_app = 'SHOPS';    let id = $(obj).attr('data-id');    show_shop_raport(id);}function show_shop_raport(id) {    SENDER_APP('get_shop_raport', {id: id}, function (mess) {        mess_executer(mess, function (mess) {            console.dir(mess);            $('.win-details').prop('open', this);            $('.win-details div').html(mess.params.html);        })    });}function toggle_status_shop(obj, status, id_shop) {    buffer_app = 'SHOPS';    SENDER_APP('toggle_status_shop', {id_shop: id_shop}, function(mess) {        mess_executer(mess, function(mess) {            show_shop_raport(id_shop);        });    });}function clear_shops_list(obj) {    setTimeout(function() {        $('#all-shops').empty();        $(obj).val('');    }, 300);}function all_shops() {    buffer_app = 'SHOPS';    let win = create_window(transform_pos('center'), 'Все магазины');    SENDER_APP('get_all_shops', {}, function (mess) {        mess_executer(mess, function (mess) {            win.css('max-height', '200px').css('overflow-y', 'auto').css('padding', '10px');            win.addClass('flex gap-5 flex-wrap');            console.dir(mess);            for(let i in mess.params) {                win.append('<button onclick="show_shop_raport('+mess.params[i].id+')" class="action-btn btn-gray btn-gray-text not-border micro-btn">'+mess.params[i].name+'</button>');            }        })    });}function user_card(id) {    let win = create_window(undefined, 'Профиль:');    open_card(win, 'users', id, {}, function() {        $(win).closest('.window').find('h4 button:nth-child(2)').remove();        $(win).closest('.window').find('h4').prepend('<div class="logo-table"><img src="/IMG/SYS/infocard.svg"></div>');    });}function show_all_products(id_shop, name_shop) {    let win = create_window(undefined, 'ТОВАРЫ ПЛОЩАДКИ "'+name_shop+'"');    get_template('products-of-shop', {id_shop: id_shop}).then(function(dt) {        win.html(dt);    }).catch(function(er) {        console.error('Ошибка промиса...');    });}function change_all(obj) {    let s = $(obj).prop('checked');    obj = $(obj).closest('.all-products');    if(s) {        $(obj).find('input[type="checkbox"]').prop('checked', true);    } else {        $(obj).find('input[type="checkbox"]').prop('checked', false);    }}function del_checked(obj, id_shop) {    let arr = [];    $(obj).closest('.window').find('tr:not(:first-child, .invisible)').each(function(e,t) {        if($(t).find('input[type="checkbox"]').prop('checked')) {            arr.push($(t).attr('data-id_prod'));        }    });    info_qest(undefined, function() {        buffer_app = 'SHOPS';        SENDER_APP('delete_prods_arr', {id_shop: id_shop, ids: arr}, function(mess) {            mess_executer(mess, function(mess) {                for(let i in arr) {                    $(obj).closest('.window').find('tr[data-id_prod="'+arr[i]+'"]').remove();                }            });        });    }, function() {    }, '💀 Подтвердите полное удаление '+arr.length+'шт. объявлений ?', 'ДА - удалить', 'НЕТ - не удалять');}function toggle_checked(obj, id_shop, status) {    let arr = [];    $(obj).closest('.window').find('tr:not(:first-child, .invisible)').each(function(e,t) {        if($(t).find('input[type="checkbox"]').prop('checked')) {            arr.push(id_shop+'_'+$(t).attr('data-id_prod'));        }    });    toggle_status_array(arr, $(obj).closest('.window').find('table'), status);}function toggle_item(obj) {    let code_prod = $(obj).closest('tr').attr('data-id');    let stat = true;    if($(obj).text() === 'ON') {        stat = false;    }    toggle_status_array([code_prod], $(obj).closest('table'), stat);}function finder_prods(obj) {    let txt = $(obj).val();    $(obj).closest('table').find('tr:not(:first-child)').each(function(e,t) {        if($(t).attr('data-text').includes(txt)) {            $(t).removeClass('invisible');        } else {            $(t).addClass('invisible');        }    });}function toggle_status_array(codes_arr, parent_table, set_status=true) {    buffer_app = 'SHOPS';    let shop_id = codes_arr[0].split('_')[0];    let arr = [];    for(let i in codes_arr) {        arr.push(codes_arr[i].split('_')[1]);    }    SENDER_APP('toggle_status_prod', {ids: arr, shop_id: shop_id, status: set_status}, function(mess) {        $(parent_table).find('tr:not(:first-child, .invisible)').each(function(e,t) {            if(arr.includes($(t).attr('data-id_prod'))) {                let cont = $(t).find('.btn-checker');                if (!set_status) {                    cont.removeClass('on_').addClass('off_').text('OFF');                } else {                    cont.removeClass('off_').addClass('on_').text('ON');                }            }        });    });}