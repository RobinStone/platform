<?php$data = file_get_contents('php://input');$data = json_decode($data, true);// Тут происходит разделение что пришло сообщение или data с кнопкиif (isset($data['callback_query'])) {    $callBackData = $data['callback_query']['data'];    $id_user = $data['callback_query']['from']['id'];} else {    $id_user = $data['message']['chat']['id'];    $message = isset($data['message']['text']) ? $data['message']['text'] : '';    $firstName = isset($data['message']['chat']['first_name']) ? $data['message']['chat']['first_name'] : '';    $lastName = isset($data['message']['chat']['last_name']) ? $data['message']['chat']['last_name'] : '';    $login_user = TELE::idTELE_to_loginUSER($id_user);}//say($data);if(isset($message)) {    q("INSERT INTO `tele` SET     `sender` = '" . $id_user . "',    `created` = '" . date('Y-m-d H:i:s') . "',    `mess` = '" . db_secur($message) . "'    ");}$ans = Core::$SiteName . " принял сообщение...";TELE::send_at_user_name('robin', $id_user.' Написал в чат '.$message);if (isset($data['message']['contact'])) {    $row = SUBD::getLineDB('users', 'tele', $data['message']['contact']['user_id']);    if (is_array($row)) {        q("UPDATE `users` SET `phone` = '" . db_secur($data['message']['contact']['phone_number']) . "' WHERE `id` = " . (int)$row['id'] . " ");        $P = new PROFIL((int)$row['id']);        $P->set('phone', $data['message']['contact']['phone_number']);    }    $ans = '';    TELE::hide_kelboard($id_user);}if(mb_strlen($message) === 4) {    if(mb_strlen((string)(int)$message) === mb_strlen($message)) {        if (TELE::idTELE_to_idUSER($id_user) !== false) {            $message = '/start acode_' . $message;        }    }}switch ($message) {    case '/start':    case '/start auth':        $row = '';        $ask = q("SELECT * FROM `users` WHERE `tele` = '" . $id_user . "' LIMIT 1");        if ($ask->num_rows) {            $row = $ask->fetch_assoc();        }        if (is_array($row)) {            $rnd = rand(10000, 99999);            $code = md5($id_user . date('H:i:s'));            $id = TELE::idTELE_to_idUSER($id_user);            Access::set_system_message($code, $row['login'], ActionsList::AUTH, (int)$row['id'], 300);            $ans = "Привет, а я вас знаю!\r\nВы - " . $row['login'] . "\r\nа вот - прямая ссылка для входа в Ваш кабинет:\r\n" . Core::$DOMAIN . "profil?title=account&tele-auth=" . $code;        } else {            $code = rand(10000, 99999) . '-' . rand(100, 999);            $ret = TELE::registred_new_user($data, $code);            $code = md5($ret['id_user'] . date('H:i:s'));            TELE::send_at_user_name('robin', 'Новый пользователь в системе (' . $ret['login'] . ')');            Access::set_system_message($code, $ret['login'], ActionsList::AUTH, (int)$ret['id_user'], 300);            $ans = "Здравствуйте. Я - бот помощник, замечательного сайта RUMBRO.ru\r\nЯ буду помогать освоиться тут.\r\nВот ссылка на Ваш персональный кабинет.\r\nНадеюсь вам у нас понравиться :\r\n".Core::$DOMAIN . "profil?title=account&tele-auth=" . $code;            TELE::get_phone_number($id_user);        }        break;    case '++users':        $ans = 'ACCESS LOW';        break;    default :        if (mb_stristr($message, '/start acode_') !== false) {            $code = mb_substr($message, 13, 100);            $ask = q("                SELECT * FROM `messages` WHERE                 `actor` = '".db_secur($code)."' AND                `active` = 1 AND                `datatime` >= '".date('Y-m-d H:i:s')."' AND                `action` = '".ActionsList::REG."' LIMIT 1                ");            if($ask->num_rows) {                $row = $ask->fetch_assoc();                $us = SUBD::getLineDB('users', 'tele', $id_user);                if(is_array($us)) {  // тут вырубаем событие что бы его не стёр CRON                    q("                        UPDATE `messages` SET                          `active` = 0,                        `target` = '".$us['id']."',                        `params` = 'auth'                        WHERE `id` = ".(int)$row['id']."                        ");                    $ans = "Мы обнаружили, что ВЫ уже регистрировались в нашей системе.\r\nПодождите несколько секунд, пока система откроет доступ.\r\nСтраница откроется самостоятельно...";                } else {                    if(mb_strlen($code) > 4) {                        $arr = TELE::registred_new_user($data, $code);                        q("                            UPDATE `messages` SET                              `active` = 0,                            `target` = '".$arr['id_user']."',                            `params` = 'reg'                            WHERE `id` = ".(int)$row['id']."                            ");                        $ans = "Регистрация успешно завершена.\r\nВернитесь на страницу с QR-кодом и ожидайте авто-входа.";                    } else {                        $ans = 'Что то пошло не так... :(';                    }                }            } else {                $ans = "Ошибка регистрации по QR (возможно срок годности кода - прошёл...)";            }            break;        }        if (mb_stristr($message, '/start uplink') !== false) {            $code = mb_substr($message, 13, 100);            $row = SUBD::getLineDB('users', 'text', $code);            if (is_array($row)) {                q("UPDATE `users` SET `tele` = '" . $id_user . "' WHERE `id` = " . (int)$row['id'] . " ");                $ans = "Ссылка на доступ\r\n" . Core::$DOMAIN . "?tele-auth=" . $code;            } else {                $ans = "Не знаю вас...";            }            break;        }        if (mb_stristr($message, '/start telesubstr') !== false) {            $ans = 'Что-то пошло не так...';            $code = mb_substr($message, 17, 100);            $row = SUBD::getLineDB('messages', 'target', $code);            if(is_array($row)) {                if($row['action'] === 'сообщение telegram' && (int)$row['active'] === 1) {                    PROFIL::create((int)$row['params'], PROFIL_TYPE::id)->set_field('tele', $id_user);                    $ans = 'Телеграмм аккаунт успешно привязан. Теперь вы сможете узнавать всё самое важное сразу же...';                }            }            break;        }        if (mb_stristr($message, '/start tele_auth') !== false) {            $code = md5($id_user . date('H:i:s'));            $id = TELE::idTELE_to_idUSER($id_user);            if ($id === false) {                $ans = "Неясное управление кода";            } else {                q("UPDATE `users` SET `text` = '" . db_secur($code) . "' WHERE `id` = " . (int)$id . " ");                $ans = "Вот ссылка на авто-вход\r\n" . Core::$DOMAIN . "?tele-auth=" . $code;            }            break;        }        if (strlen($message) >= 2 && substr($message, 0, 2) === '++') {            switch ($message) {                case '++help':                    $ans = '';                    break;                default :                    if (stripos($message, '++пароль') !== false) {                        $pass = explode('(', $message)[1];                        $pass = substr($pass, 0, -1);                        $id = TELE::idTELE_to_idUSER($id_user);                        if ($id !== false) {                            q("UPDATE `users` SET `password` = '" . crypter($pass) . "' WHERE `id` = " . (int)$id . " ");                            $ans = "пароль был изменён\r\n" . $pass;                        } else {                            $ans = "что то не то";                        }                    } else {                        say('++пароль === ' . $message);                        $ans = "какой-то треш";                    }                    break;            }        } else {        }        break;}if (isset($callBackData)) {    TELE::actions($callBackData, $id_user);    exit;}if ($ans !== '') {    TELE::send($id_user, $ans);}//TELEGRAM::send('585347020', 'Новый пользователь'); - мой аккаунт//TELEGRAM::send('1805860767', 'Новый пользователь'); - моя маша