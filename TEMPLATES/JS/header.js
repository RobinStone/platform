stay_visible = new Event();stay_hidden = new Event();global_pos = {    latitude:0,    longitude:0,};navigator.geolocation.getCurrentPosition(function(position) {    let latitude = position.coords.latitude;    let longitude = position.coords.longitude;    console.log('latitude='+latitude);    console.log('longitude='+longitude);    global_pos.latitude = latitude;    global_pos.longitude = longitude;    setCookies('geo', latitude+'|'+longitude);}, function(err) {    if(err.code === 2) {        console.log('Системе не удалось точно определить ваш адрес... :(');    } else {        console.info('Без разрешения к текущему местоположению, системе будет сложно показывать ближайшие к вам магазины...');    }});$(document).on('blur', '#finder', function(e) {    setTimeout(function() {        $('#results').remove();        $('#finder').val('');    }, 200);});/** * Загружает меню или по требованию или спустя время */$(function() {    console.log('--- HEADER ---');    setTimeout(function() {        get_template('menu').then(function(tpl) {            $('header').append(tpl);        }).catch(function(err) {            console.error(err);        });    }, 500);    if(is_mobile()) {        let header = $('.up-row-header');        let finder = $('.find-field');        let logo = $('.logo-row');        let op = 1;        let search_in_header = false;        $(window).scroll(function () {            let st = $(this).scrollTop();            op = 1-(st/250);            if(op < 0) { op = 0; }            logo.css('opacity', op);            if(st >= 250) {                if(!search_in_header) {                    find_row_set_heared();                }            } else if(st < 200) {                if(search_in_header) {                    find_row_set_heared(false);                }            }        });        function find_row_set_heared(setter=true) {            if(setter) {                $('#body-s main').addClass('header-padding');                finder.addClass('trans-up');                header.find('.profil-btn-action').before(finder);                header.find('.logo-row').addClass('visually-hidden');                search_in_header = true;                setTimeout(function() {                    finder.addClass('showed');                }, 30);            } else {                $('#body-s main').removeClass('header-padding');                search_in_header = false;                finder.removeClass('showed');                header.closest('header').append(finder);                setTimeout(function() {                    finder.removeClass('trans-up');                    header.find('.logo-row').removeClass('visually-hidden');                }, 100);            }        }    }});system_come = new Event();document.addEventListener('DOMContentLoaded', function() {    system_come.subscribe(function(mess) {        if($('#results').length === 0) {            $('#finder').parent().append('<div id="results"></div>');        }        if(mess.RESULT !== null) {            $('#results').empty();            let obj = mess.RESULT;            let div = '';            console.dir(obj);            let link = '';            for(let i in obj) {                switch(obj[i]['TYPE']) {                    case 'PRODUCT':                        link = '/'+obj[i]['MAIN_CAT_TRANS'];                        if(obj[i]['UNDER_CAT_TRANS'] !== '') { link += '/'+obj[i]['UNDER_CAT_TRANS']; }                        if(obj[i]['ACTION_LIST_TRANS'] !== '') { link += '/'+obj[i]['ACTION_LIST_TRANS']; }                        link += '?s='+obj[i]['SHOP_ID']+'&prod='+obj[i]['ID'];                        div = $('<div class="find-row flex between"><a href="'+link+'">'+obj[i]['NAME']+'</a><span onclick="location.href=\'/'+obj[i]['MAIN_CAT_TRANS']+'\'" class="cat-link">'+obj[i]['MAIN_CAT']+'</span></div>');                        $('#results').append(div);                        break;                    case 'LINK':                        link = obj[i]['LINK'];                        div = $('<div title="'+obj[i]['HINT']+'" class="find-row flex between"><a class="cat-link-one" href="'+obj[i]['LINK']+'">'+obj[i]['NAME']+'</a></div>');                        $('#results').append(div);                        break;                }            }        } else {            $('#results').remove();        }    });    let url = new URL(location.href);    if(url.searchParams.get('title') === 'favorite') {        $('#q-best').addClass('sel');    } else {        // say(url.pathname);        switch(url.pathname) {            case '/': $('#q-home').addClass('sel'); break;            case '/profil': $('#q-profil').addClass('sel'); break;            case '/messenger': $('#q-mess').addClass('sel'); break;        }    }});$(document).on('keyup', '#finder-sity', function(e) {    // citys-list    let txt = $(this).val();    if(txt.length > 0) {        SENDER('get_citys', {txt: txt}, function (mess) {            mess_executer(mess, function (mess) {                console.dir(mess);                update_places_list(mess.params);            });        });    }});$(document).on('blur', '#finder-sity', function(e) {    $(this).remove();});$(document).on('change', '#finder-sity', function(e) {    let obj = this;    let txt = $(this).val().split(', ')[0];    setCookies('my_place', txt+'|'+translit(txt));    $('span[data-my_place]').text('г. '+txt);    $('span[data-my_place]').attr('data-my_place', translit(txt));    setTimeout(function() {        $(obj).remove();        location.reload();    }, 30);});startY = null;document.addEventListener('touchstart', function (e) {    startY = e.touches[0].clientY; // сохраняем координаты Y при касании});document.addEventListener('touchend', function (e) {    if($mobile) {        let endY = e.changedTouches[0].clientY;        let diff = endY - startY;        // if (diff > 0) {        //     $('.quick_access').removeClass('show');        // } else if (diff < 0) {        //     $('.quick_access').addClass('show');        // }    }});function create_my_order() {    if(user_id === -1) {        say('Подача объявления доступна только зарегистрированным пользователям!..', 2);    } else {        buffer_app = 'SHOPS';        SENDER_APP('scan_and_set_shop_add', {}, function(mess) {            mess = JSON.parse(mess);            if(mess.status !== 'ok') {                error_executing(mess);            } else {                location.href='/create';            }        });    }}document.addEventListener("visibilitychange", function() {    let url = new URL(location.href);    if (document.hidden) {        console.log("Вкладка стала скрытой");        stay_hidden.action(url);    } else {        console.log("Вкладка стала видимой");        stay_visible.action(url);    }});window.addEventListener('load', function() {    console.log('Before window included...');    if(typeof new_alert === 'undefined') {        new_alert = new Event();    }    new_alert.subscribe(function(mess) {        let url = new URL(location.href);        // status_chat = visible or hidden        if(url.pathname !== '/messenger' && current_room !== mess.room_id) {            $('.action-menu li:first-child').addClass('alert');        }    });});function change_my_place(obj) {    if($(obj).find('input').length === 0) {        let inpt = $('<input id="finder-sity" type="text" list="citys-list" placeholder="' + $(obj).text() + '">');        $(obj).append(inpt);        $(inpt).focus();    }    if($('#citys-list').length === 0) {        let tmp = $('<datalist id="citys-list"></datalist>');        $('.header').append(tmp);    }}function update_places_list(lst) {    $('#citys-list').empty();    for(let i in lst) {        $('#citys-list').append('<option data-city="'+lst[i]['name']+'">'+lst[i]['name']+', '+lst[i]['country']+'</option>');    }}function finder(obj) {    let par = $(obj).parent();    let txt = $(obj).val();    if(txt.length > 0) {        let arr = {            com: 'finder',            text: txt        }        system_send(arr);    } else {        $('#results').remove();    }}function basket_set(item, type='basket') {    let tp = '#basket-count';    if(type === 'deffer') {        tp = '#deffer-count';    }    if(type === 'compare') {        tp = '#compare-count';    }    if(item === '+') {        let count = parseInt($(tp).text());        ++count;        $(tp).text(count);    } else if(item === '-') {        let count = parseInt($(tp).text());        --count;        if(count > 0) {            $(tp).text(count);        } else {            $(tp).text(0);        }    } else {        item = parseInt(item);        $(tp).text(item);    }}$(document).on('keydown', '#finder', function(e) {    let obj = $(this).closest('.find-field').find('button');    if(e.keyCode === 13) {        search_context(obj);    }});function search_context(obj) {    let txt = $(obj).closest('.find-field').find('input').val();    location.href='/finder?text='+txt;}function toggle_controls() {    say('work');    if($('.quick_access').hasClass('hidden-header')) {        header_footer_set(true);    } else {        header_footer_set(false);    }}